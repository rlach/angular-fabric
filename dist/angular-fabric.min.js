angular.module("common.fabric",["common.fabric.window","common.fabric.directive","common.fabric.canvas","common.fabric.dirtyStatus"]).factory("Fabric",["FabricWindow","$timeout","$window","FabricCanvas","FabricDirtyStatus",function(e,t,n,i,o){"use strict";return function(n){function a(e){return"string"!=typeof e?"":e.charAt(0).toUpperCase()+e.slice(1)}function c(e,t){return t=t||f.getActiveObject(),"object"!=typeof t||null===t?"":t.getSelectionStyles&&t.isEditing?t.getSelectionStyles()[e]||"":t[e]||""}function r(e,t,n){if(n=n||f.getActiveObject(),n.setSelectionStyles&&n.isEditing){var i={};i[e]=t,n.setSelectionStyles(i)}else n[e]=t;v.render()}function l(e,t){return t=t||f.getActiveObject(),"object"==typeof t&&null!==t?t[e]:""}function s(e,t,n){n=n||f.getActiveObject(),n.set(e,t),v.render()}function u(e,t,n){t=t||"",n=n||512;for(var i=atob(e),o=[],a=0;a<i.length;a+=n){for(var c=i.slice(a,a+n),r=new Array(c.length),l=0;l<c.length;l++)r[l]=c.charCodeAt(l);var s=new Uint8Array(r);o.push(s)}var u=new Blob(o,{type:t});return u}function d(e){return/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/gi.test(e)}var f,g,v=angular.extend({canvasBackgroundColor:"#ffffff",canvasWidth:300,canvasHeight:300,canvasOriginalHeight:300,canvasOriginalWidth:300,maxContinuousRenderLoops:25,continuousRenderTimeDelay:500,editable:!0,JSONExportProperties:[],loading:!1,dirty:!1,initialized:!1,userHasClickedCanvas:!1,downloadMultipler:2,imageDefaults:{},textDefaults:{},shapeDefaults:{},windowDefaults:{transparentCorners:!1,rotatingPointOffset:25,padding:0},canvasDefaults:{selection:!1}},n);return v.renderCount=0,v.render=function(){var e=f.getObjects();for(var t in e)e[t].setCoords();f.calcOffset(),f.renderAll(),v.renderCount++},v.setCanvas=function(e){f=e,f.selection=v.canvasDefaults.selection},v.setTextDefaults=function(e){v.textDefaults=e},v.setJSONExportProperties=function(e){v.JSONExportProperties=e},v.setCanvasBackgroundColor=function(e){v.canvasBackgroundColor=e,f.setBackgroundColor(e),v.render()},v.setCanvasWidth=function(e){v.canvasWidth=e,f.setWidth(e),v.render()},v.setCanvasHeight=function(e){v.canvasHeight=e,f.setHeight(e),v.render()},v.setCanvasSize=function(e,t){v.stopContinuousRendering();var n=v.canvasScale;v.resetZoom(),v.canvasWidth=e,v.canvasOriginalWidth=e,f.originalWidth=e,f.setWidth(e),v.canvasHeight=t,v.canvasOriginalHeight=t,f.originalHeight=t,f.setHeight(t),v.canvasScale=n,v.render(),v.setZoom(),v.render(),v.setZoom()},v.deactivateAll=function(){f.deactivateAll(),v.deselectActiveObject(),v.render()},v.clearCanvas=function(){f.clear(),f.setBackgroundColor("#ffffff"),v.render()},v.addObjectToCanvas=function(e){e.originalScaleX=e.scaleX,e.originalScaleY=e.scaleY,e.originalLeft=e.left,e.originalTop=e.top,f.add(e),v.setObjectZoom(e),f.setActiveObject(e),e.bringToFront(),v.center(),v.render()},v.addImage=function(t,n){e.Image.fromURL(t,function(t){t.id=v.createId();for(var i in v.imageOptions)t[i]=v.imageOptions[i];var o=new e.Image.filters.Tint({color:"#ffffff",opacity:0});t.filters.push(o),t.applyFilters(f.renderAll.bind(f)),v.addObjectToCanvas(t),n(t)},v.imageDefaults)},v.getCanvas=function(){return f},v.addShape=function(t,n,i){e.loadSVGFromURL(t,function(t,n){var o=e.util.groupSVGElements(t,n);o.id=v.createId(),v.addObjectToCanvas(o),i(o)})},v.addText=function(t){t=t||"New Text";var n=new e.Text(t,v.textDefaults);return n.id=v.createId(),v.addObjectToCanvas(n),n},v.addIText=function(t){t=t||"New Text";var n=new e.IText(t,v.textDefaults);return n.id=v.createId(),v.addObjectToCanvas(n),n},v.addTextbox=function(t,n){t=t||"New Text",n=n||!1;var i=new e.Textbox(t,v.textDefaults);return i.id=v.createId(),i.editable=n,v.addObjectToCanvas(i),i},v.getText=function(e){return l("text",e)},v.setText=function(e,t){s("text",e,t)},v.getFontSize=function(e){return c("fontSize",e)},v.setFontSize=function(e,t){r("fontSize",parseInt(e,10),t),v.render()},v.getTextAlign=function(e){return a(l("textAlign",e))},v.setTextAlign=function(e,t){s("textAlign",e.toLowerCase()),t},v.getFontFamily=function(e){var t=l("fontFamily",e);return t?t.toLowerCase():""},v.setFontFamily=function(e,t){s("fontFamily",e.toLowerCase(),t)},v.getLineHeight=function(e){return c("lineHeight",e)},v.setLineHeight=function(e){r("lineHeight",parseFloat(e,10),object),v.render()},v.isBold=function(e){return"bold"===c("fontWeight",e)},v.toggleBold=function(e){r("fontWeight","bold"===c("fontWeight",e)?"":"bold",e),v.render()},v.isItalic=function(e){return"italic"===c("fontStyle",e)},v.toggleItalic=function(e){r("fontStyle","italic"===c("fontStyle",e)?"":"italic",e),v.render()},v.isUnderline=function(e){return c("textDecoration",e).indexOf("underline")>-1},v.toggleUnderline=function(e){var t=v.isUnderline(e)?c("textDecoration",e).replace("underline",""):c("textDecoration",e)+" underline";r("textDecoration",t,e),v.render()},v.isLinethrough=function(e){return c("textDecoration",e).indexOf("line-through")>-1},v.toggleLinethrough=function(e){var t=v.isLinethrough(e)?c("textDecoration",e).replace("line-through",""):c("textDecoration",e)+" line-through";r("textDecoration",t,e),v.render()},v.getTextAlign=function(e){return l("textAlign",e)},v.setTextAlign=function(e,t){s("textAlign",e,t)},v.getOpacity=function(e){return c("opacity",e)},v.setOpacity=function(e,t){r("opacity",e,t)},v.getFlipX=function(e){return l("flipX",e)},v.setFlipX=function(e,t){s("flipX",e,t)},v.toggleFlipX=function(e){var t=!v.getFlipX(e);v.setFlipX(t,e),v.render()},v.center=function(e){e=e||f.getActiveObject(),e&&(e.center(),v.updateObjectOriginals(e),v.render())},v.centerH=function(e){e=e||f.getActiveObject(),e&&(e.centerH(),v.updateObjectOriginals(e),v.render())},v.centerV=function(e){e=e||f.getActiveObject(),e&&(e.centerV(),v.updateObjectOriginals(e),v.render())},v.sendBackwards=function(e){e=e||f.getActiveObject(),e&&(f.sendBackwards(e),v.render())},v.sendToBack=function(e){e=e||f.getActiveObject(),e&&(f.sendToBack(e),v.render())},v.bringForward=function(e){e=e||f.getActiveObject(),e&&(f.bringForward(e),v.render())},v.bringToFront=function(e){e=e||f.getActiveObject(),e&&(f.bringToFront(e),v.render())},v.isTinted=function(e){return l("isTinted",e)},v.toggleTint=function(e){e=e||f.getActiveObject(),e.isTinted=!e.isTinted,e.filters[0].opacity=e.isTinted?1:0,e.applyFilters(f.renderAll.bind(f))},v.getTint=function(e){return e=e||f.getActiveObject(),"object"!=typeof e||null===e?"":void 0!==e.filters&&void 0!==e.filters[0]?e.filters[0].color:void 0},v.setTint=function(e,t){d(e)&&(t=t||f.getActiveObject(),void 0!==t.filters&&void 0!==t.filters[0]&&(t.filters[0].color=e,t.applyFilters(f.renderAll.bind(f))))},v.getFill=function(e){return c("fill",e)},v.setFill=function(e,t){t=t||f.getActiveObject(),t&&("text"===t.type?r("fill",e,t):v.setFillPath(t,e))},v.setFillPath=function(e,t){if(e.isSameColor&&e.isSameColor()||!e.paths)e.setFill(t);else if(e.paths)for(var n=0;n<e.paths.length;n++)e.paths[n].setFill(t)},v.resetZoom=function(){v.canvasScale=1,v.setZoom()},v.setZoom=function(){var e=f.getObjects();for(var t in e)e[t].originalScaleX=e[t].originalScaleX?e[t].originalScaleX:e[t].scaleX,e[t].originalScaleY=e[t].originalScaleY?e[t].originalScaleY:e[t].scaleY,e[t].originalLeft=e[t].originalLeft?e[t].originalLeft:e[t].left,e[t].originalTop=e[t].originalTop?e[t].originalTop:e[t].top,v.setObjectZoom(e[t]);v.setCanvasZoom(),v.render()},v.setObjectZoom=function(e){var t=e.originalScaleX,n=e.originalScaleY,i=e.originalLeft,o=e.originalTop,a=t*v.canvasScale,c=n*v.canvasScale,r=i*v.canvasScale,l=o*v.canvasScale;e.scaleX=a,e.scaleY=c,e.left=r,e.top=l,e.setCoords()},v.setCanvasZoom=function(){var e=v.canvasOriginalWidth,t=v.canvasOriginalHeight,n=e*v.canvasScale,i=t*v.canvasScale;f.setWidth(n),f.setHeight(i)},v.updateObjectOriginals=function(e){e&&(e.originalScaleX=e.scaleX/v.canvasScale,e.originalScaleY=e.scaleY/v.canvasScale,e.originalLeft=e.left/v.canvasScale,e.originalTop=e.top/v.canvasScale)},v.updateActiveObjectOriginals=function(){var e=f.getActiveObject();v.updateObjectOriginals(e)},v.toggleLock=function(e){e&&(e.lockMovementX=!e.lockMovementX,e.lockMovementY=!e.lockMovementY,e.lockScalingX=!e.lockScalingX,e.lockScalingY=!e.lockScalingY,e.lockUniScaling=!e.lockUniScaling,e.lockRotation=!e.lockRotation,e.lockObject=!e.lockObject,v.render())},v.toggleLockActiveObject=function(){var e=f.getActiveObject();v.toggleLock(e)},v.selectActiveObject=function(e){e=e||f.getActiveObject(),e&&(v.selectedObject=e,v.selectedObject.text=v.getText(e),v.selectedObject.fontSize=v.getFontSize(e),v.selectedObject.lineHeight=v.getLineHeight(e),v.selectedObject.textAlign=v.getTextAlign(e),v.selectedObject.opacity=v.getOpacity(e),v.selectedObject.fontFamily=v.getFontFamily(e),v.selectedObject.fill=v.getFill(e),v.selectedObject.tint=v.getTint(e))},v.deselectActiveObject=function(){v.selectedObject=!1},v.deleteObject=function(e){f.remove(e),v.render()},v.deleteActiveObject=function(){var e=f.getActiveObject();v.deleteObject(e)},v.isLoading=function(){return v.loading},v.setLoading=function(e){v.loading=e},v.setDirty=function(e){o.setDirty(e)},v.isDirty=function(){return o.isDirty()},v.setInitalized=function(e){v.initialized=e},v.isInitalized=function(){return v.initialized},v.getJSON=function(){var e=v.canvasScale;v.canvasScale=1,v.resetZoom();var t=JSON.stringify(f.toJSON(v.JSONExportProperties));return v.canvasScale=e,v.setZoom(),t},v.loadJSON=function(e){v.setLoading(!0),f.loadFromJSON(e,function(){t(function(){v.setLoading(!1),v.editable||v.disableEditing(),v.render()})})},v.getCanvasData=function(){var e=f.toDataURL({width:f.getWidth(),height:f.getHeight(),multiplier:v.downloadMultipler});return e},v.getCanvasBlob=function(){var e=v.getCanvasData(),t=e.replace("data:image/png;base64,",""),n=u(t,"image/png"),i=URL.createObjectURL(n);return i},v.download=function(e){v.deactivateAll();var t=v.canvasScale;v.resetZoom();var n=document.createElement("a"),i=e+".png";n.download=i,n.href=v.getCanvasBlob(),n.click(),v.canvasScale=t,v.setZoom()},v.continuousRenderCounter=0,v.continuousRenderHandle=null,v.stopContinuousRendering=function(){t.cancel(v.continuousRenderHandle),v.continuousRenderCounter=v.maxContinuousRenderLoops},v.startContinuousRendering=function(){v.continuousRenderCounter=0,v.continuousRender()},v.continuousRender=function(){v.userHasClickedCanvas||v.continuousRenderCounter>v.maxContinuousRenderLoops||(v.continuousRenderHandle=t(function(){v.setZoom(),v.render(),v.continuousRenderCounter++,v.continuousRender()},v.continuousRenderTimeDelay))},v.setUserHasClickedCanvas=function(e){v.userHasClickedCanvas=e},v.createId=function(){return Math.floor(1e4*Math.random())},v.disableEditing=function(){f.selection=!1,f.forEachObject(function(e){e.selectable=!1})},v.enableEditing=function(){f.selection=!0,f.forEachObject(function(e){e.selectable=!0})},v.setCanvasBackgroundImage=function(e){v.backgroundImage=e,f.setBackgroundImage(e),v.render()},v.setCanvasDefaults=function(){f.selection=v.canvasDefaults.selection},v.setWindowDefaults=function(){e.Object.prototype.transparentCorners=v.windowDefaults.transparentCorners,e.Object.prototype.rotatingPointOffset=v.windowDefaults.rotatingPointOffset,e.Object.prototype.padding=v.windowDefaults.padding},v.startCanvasListeners=function(){f.on("object:selected",function(){v.stopContinuousRendering(),t(function(){v.selectActiveObject(),v.setDirty(!0)})}),f.on("selection:created",function(){v.stopContinuousRendering()}),f.on("selection:cleared",function(){t(function(){v.deselectActiveObject()})}),f.on("after:render",function(){f.calcOffset()}),f.on("object:modified",function(){v.stopContinuousRendering(),t(function(){v.updateActiveObjectOriginals(),v.setDirty(!0)})})},v.init=function(){f=i.getCanvas(),v.canvasId=i.getCanvasId(),f.clear(),g=angular.fromJson(v.json),v.loadJSON(v.json),g=g||{},v.canvasScale=1,g.background=g.background||"#ffffff",v.setCanvasBackgroundColor(g.background),v.setCanvasBackgroundImage(g.bgDefaultImage),g.width=g.width||300,v.canvasOriginalWidth=g.width,g.height=g.height||300,v.canvasOriginalHeight=g.height,v.setCanvasSize(v.canvasOriginalWidth,v.canvasOriginalHeight),v.render(),v.setDirty(!1),v.setInitalized(!0),v.setCanvasDefaults(),v.setWindowDefaults(),v.startCanvasListeners(),v.startContinuousRendering(),o.startListening()},v.init(),v}}]);
angular.module("common.fabric.canvas",["common.fabric.window"]).service("FabricCanvas",["FabricWindow","$rootScope",function(t,a){"use strict";function e(){return Math.floor(1e4*Math.random())}var n={canvasId:null,element:null,canvas:null};return n.setElement=function(t){n.element=t,a.$broadcast("canvas:element:selected")},n.createCanvas=function(){return n.canvasId="fabric-canvas-"+e(),n.element.attr("id",n.canvasId),n.canvas=new t.Canvas(n.canvasId),a.$broadcast("canvas:created"),n.canvas},n.getCanvas=function(){return n.canvas},n.getCanvasId=function(){return n.canvasId},n.fixCanvasToBoundary=function(t){if(t.target){var a=t.target;if(!(a.currentHeight>a.canvas.height||a.currentWidth>a.canvas.width)){a.setCoords();var e=a.getBoundingRect();(e.top<0||e.left<0)&&(a.top=Math.max(a.top,a.top-e.top),a.left=Math.max(a.left,a.left-e.left)),(e.top+e.height>a.canvas.height||e.left+e.width>a.canvas.width)&&(a.top=Math.min(a.top,a.canvas.height-e.height+a.top-e.top),a.left=Math.min(a.left,a.canvas.width-e.width+a.left-e.left))}}},n.focusCanvasWrapper=function(t){t=t.canvas||n.canvas,t.wrapperEl.focus()},n.calculateTextWidth=function(t){var a=t.textAlign,e=t.ctx;e.save(),t._setTextStyles(e),t.textAlign="left";for(var n=t.text,c=0,r=0,i="",s=n.split(" "),o="",l=0,v=" ",f=0,u=0,h=0,d=!0,g=t._getWidthOfCharSpacing(),m=0;m<s.length;m++)o=s[m],f=t._measureText(e,o,r,l),l+=o.length,c+=u+f-g,c+=g,d||(i+=v),i+=o,u=t._measureText(e,v,r,l),l++,d=!1,f>h&&(h=f);return t.textAlign=a,e.restore(),c},n.resizeTextBox=function(t,a){var e=n.calculateTextWidth(t)+5;a&&e>a&&(e=a),t.width=e},n}]);
angular.module("common.fabric.constants",[]).service("FabricConstants",[function(){"use strict";var e={rotatingPointOffset:20,padding:0,borderColor:"EEF6FC",cornerColor:"rgba(64, 159, 221, 1)",cornerSize:10,transparentCorners:!1,hasRotatingPoint:!0,centerTransform:!0};return{presetSizes:[{name:"Portrait (8.5 x 11)",height:1947,width:1510},{name:"Landscape (11 x 8.5)",width:1947,height:1510},{name:"Business Card (3.5 x 2)",height:368,width:630},{name:"Postcard (6 x 4)",height:718,width:1068},{name:"Content/Builder Product Thumbnail",height:400,width:760},{name:"Badge",height:400,width:400},{name:"Facebook Profile Picture",height:300,width:300},{name:"Facebook Cover Picture",height:315,width:851},{name:"Facebook Photo Post (Landscape)",height:504,width:403},{name:"Facebook Photo Post (Horizontal)",height:1008,width:806},{name:"Facebook Full-Width Photo Post",height:504,width:843}],fonts:[{name:"Arial"},{name:"Impact"},{name:"Tahoma"}],shapeCategories:[{name:"Popular Shapes",shapes:["arrow6","bubble4","circle1","rectangle1","star1","triangle1"]},{name:"Simple Shapes",shapes:["circle1","heart1","rectangle1","triangle1","star1","star2","star3","square1"]},{name:"Arrows & Pointers",shapes:["arrow1","arrow9","arrow3","arrow6"]},{name:"Bubbles & Balloons",shapes:["bubble5","bubble4"]},{name:"Check Marks",shapes:[]},{name:"Badges",shapes:["badge1","badge2","badge4","badge5","badge6"]}],JSONExportProperties:["height","width","background","objects","originalHeight","originalWidth","originalScaleX","originalScaleY","originalLeft","originalTop","lineHeight","lockMovementX","lockMovementY","lockScalingX","lockScalingY","lockUniScaling","lockRotation","lockObject","id","isTinted","filters"],shapeDefaults:angular.extend({fill:"#0088cc"},e),textDefaults:angular.extend({originX:"left",scaleX:1,scaleY:1,fontFamily:"Arial",fontSize:40,fill:"#454545",textAlign:"left"},e)}}]);
function DirectiveController(e,t,c,r){"use strict";var i=function(){r.setElement(c),r.createCanvas(),$("body").on("click","canvas",function(){e.fabric.setUserHasClickedCanvas&&e.fabric.setUserHasClickedCanvas(!0)}),e.$watch("fabric.canvasBackgroundColor",function(t){e.fabric.setCanvasBackgroundColor&&e.fabric.setCanvasBackgroundColor(t)}),e.$watch("fabric.selectedObject.text",function(t){"string"==typeof t&&(e.fabric.setText(t),e.fabric.render())}),e.$watch("fabric.selectedObject.fontSize",function(t){("string"==typeof t||"number"==typeof t)&&(e.fabric.setFontSize(t),e.fabric.render())}),e.$watch("fabric.selectedObject.lineHeight",function(t){("string"==typeof t||"number"==typeof t)&&(e.fabric.setLineHeight(t),e.fabric.render())}),e.$watch("fabric.selectedObject.textAlign",function(t){"string"==typeof t&&(e.fabric.setTextAlign(t),e.fabric.render())}),e.$watch("fabric.selectedObject.fontFamily",function(t){"string"==typeof t&&t&&(e.fabric.setFontFamily(t),e.fabric.render())}),e.$watch("fabric.selectedObject.opacity",function(t){("string"==typeof t||"number"==typeof t)&&(e.fabric.setOpacity(t),e.fabric.render())}),e.$watch("fabric.selectedObject.fill",function(t){"string"==typeof t&&(e.fabric.setFill(t),e.fabric.render())}),e.$watch("fabric.selectedObject.tint",function(t){"string"==typeof t&&(e.fabric.setTint(t),e.fabric.render())})};t(i,0)}angular.module("common.fabric.directive",["common.fabric.canvas"]).directive("fabric",[function(){"use strict";return{scope:{fabric:"@"},controller:DirectiveController}}]),DirectiveController.$inject=["$scope","$timeout","$element","FabricCanvas"];
angular.module("common.fabric.dirtyStatus",[]).service("FabricDirtyStatus",["$window",function(n){"use strict";function t(){return e.isDirty()?"Oops! You have unsaved changes.\n\nPlease save before leaving so you don't lose any work.":void 0}var e={dirty:!1};return e.endListening=function(){n.onbeforeunload=null,n.onhashchange=null},e.startListening=function(){n.onbeforeunload=t,n.onhashchange=t},e.isDirty=function(){return e.dirty},e.setDirty=function(n){e.dirty=n},e}]);
angular.module("common.fabric.utilities",[]).directive("parentClick",["$timeout",function(n){"use strict";return{scope:{parentClick:"&"},link:function(t,e){e.mousedown(function(){n(function(){t.parentClick()})}).children().mousedown(function(n){n.stopPropagation()})}}}]).factory("Keypress",[function(){"use strict";var n={};return n.onKeyDown=function(n,t){n.addEventListener("keydown",function(n){t(n)},!1)},n.onKeyCode=function(t,e,o){n.onKeyDown(t,function(n){n.which===e&&(n.preventDefault(),o(n))})},n.onCtrlAndS=function(t){n.onKeyDown(document,function(n){(n.ctrlKey||n.metaKey)&&83===n.which&&(n.preventDefault(),t(n))})},n}]).filter("Reverse",[function(){"use strict";return function(n){return n?n.slice().reverse():void 0}}]).filter("ArrayContainsProperty",[function(){"use strict";return function(n,t,e){return n.some(function(n){return n&&n[e]?n[e]===t:!1})}}]);
angular.module("common.fabric.window",[]).factory("FabricWindow",["$window",function(i){"use strict";return i.fabric}]);